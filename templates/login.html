{% extends 'base.html' %}

{% block title %}{% if user and user.is_authenticated %}Hello,
    {{ user.get_full_name | default:user.username }}{% else %}UTubeU{% endif %} {% endblock %}

{% block content %}
    <div id="error_bank" class="row">

    </div>

    <div class="row">
        <div class="col-md-3">
            <ul>
                {% if user and user.is_authenticated %}
                    <li>
                        <a>Hello {{ user.get_full_name|default:user.username }}!</a>
                    </li>
                    <li>
                        <a href="{% url 'viewer:logout' %}?next={% url 'viewer:login' %}">Logout</a>
                    </li>
                {% else %}
                    <li>
                        <a href="{% url 'social:begin' 'google-oauth2' %}?next={{ request.path }}">Login with Google</a>
                    </li>
                {% endif %}
            </ul>
        </div>
        <div class="col-md-3 chatrooms">
            {% if user and user.is_authenticated %}
                {% for chatroom in chatrooms %}
                    <a href="/chatroom/{{ chatroom.pk }}" class="btn btn-info">
                        Enter {{ chatroom.name }}
                    </a>
                {% endfor %}
                {% for chatroom in owned_chatrooms %}
                    <a href="/chatroom/{{ chatroom.pk }}" class="btn btn-warning">
                        Enter {{ chatroom.name }}
                    </a>

                {% endfor %}
                </div>
                <div class="col-md-3">

                {% if number_owned < 2 %}
                    <div id="create-button" class="btn btn-success" data-toggle="collapse" data-target="#room-maker">
                        Create a chatroom.
                    </div>
                    <div id="room-maker" class="collapse">
                        <form action="{% url 'viewer:create_chatroom' %}" method="post">{% csrf_token %}
                            {{ chatroom_form }}
                            {% for form in email_formset %}
                                {{ form }}
                            {% endfor %}
                            <div id="makeit_button" class="btn btn-success">Create!</div>
                        </form>


                    </div>
                {% endif %}
            {% endif %}
            </div>
    </div>
{% endblock %}

{% block js %}

    <script>
        $(document).ready(function () {
            for (var user_number = 1; user_number < 19; user_number++) {
                var previous_with_number = 'user' + (user_number - 1).toString();
                var with_number = 'user' + user_number.toString();
                var next_sibling_selector = "#" + with_number;
                var selector = "#" + previous_with_number;

                var user_email = $('<div class="form-row"><label>Email of Friend:</label><input type="email"></div>');
                user_email.children('input').attr('id', with_number);
                user_email.children('input').attr('name', with_number);
                user_email.children('input').attr('multiple', "false");
                user_email.hide();
                $('#makeit_button').before(user_email);
                $(selector).on('input change', function () {
                    $(this).parent().next().show();
                });
            }


            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                }
            });

            $('#makeit_button').click(function () {
                var emails = $('input[type=email]').map(function () {
                    if (!$(this).val() == "") {
                        return $(this).val()
                    }
                }).get();
                var name = $('input[type=text]').val();
                var description = $('textarea').val();
                var url = $('form').attr('action');


                json_data = {
                    'user_emails': emails, 'chatroom_name': name,
                    'chatroom_description': description
                };

                $.post(url,
                        JSON.stringify(json_data)
                ).done(function (data) {
                            if(data.errors==null) {
                                $('input').val("");
                                $('textarea').val("");
                                $('#create-button').toggle();


                                $('.chatroom').append('<a href="/chatroom/' + data.chatroom_id + '" class="btn btn-warning">' + data.chatroom_name + '</a>');
                            }}).fail(function(data){
                                $('#error_bank').append('<p>'+data.errors+'</p>');

                        });
            });


        });
    </script>

{% endblock %}
