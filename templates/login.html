{% extends 'base.html' %}

{% block title %}{% if user and user.is_authenticated %}Hello,
    {{ user.get_full_name | default:user.username }}{% else %}UTubeU{% endif %} {% endblock %}

{% block content %}
    <div id="error_bank" class="row">

    </div>

    <div class="row">
        <div class="col-md-3">
            <ul>
                {% if user and user.is_authenticated %}
                    <li>
                        <a>Hello {{ user.get_full_name|default:user.username }}!</a>
                    </li>
                    <li>
                        <a href="{% url 'viewer:logout' %}?next={% url 'viewer:login' %}">Logout</a>
                    </li>
                {% else %}
                    <li>
                        <a href="{% url 'social:begin' 'google-oauth2' %}?next={{ request.path }}">Login with Google</a>
                    </li>
                {% endif %}
            </ul>
        </div>
        <div class="col-md-3 chatrooms">
            {% if user and user.is_authenticated %}
                {% for chatroom in chatrooms %}
                    <a href="/chatroom/{{ chatroom.pk }}" class="btn btn-info">
                        Enter {{ chatroom.name }}
                    </a>
                    <div class="delete_chatroom btn btn-danger glyphicon glyphicon-remove"></div>
                {% endfor %}
                {% for chatroom in owned_chatrooms %}
                    <div class="btn-group">
                        <a href="/chatroom/{{ chatroom.pk }}" class="btn btn-warning">
                            Enter {{ chatroom.name }}
                        </a>

                        <div class="delete_chatroom btn btn-danger glyphicon glyphicon-remove"></div>
                    </div>
                {% endfor %}
                </div>
                <div class="col-md-3">

                {% if number_owned < 2 %}
                    <div id="create-button" class="btn btn-success" data-toggle="collapse" data-target="#room-maker">
                        Create a chatroom.
                    </div>
                    <div id="room-maker" class="collapse">
                        <form action="{% url 'viewer:create_chatroom' %}" method="post"
                              id="post_chatroom_email_form">{% csrf_token %}
                            {{ email_formset.management_form }}
                            {{ chatroom_form }}
                            {% for form in email_formset %}
                                {{ form }}
                            {% endfor %}

                            <input type="submit" id="makeit_button" class="btn btn-success" value="Create!">
                        </form>


                    </div>
                {% endif %}
            {% endif %}
            </div>
    </div>
{% endblock %}

{% block js %}

    <script>
        $(document).ready(function () {




            $('#post_chatroom_email_form').on('submit', function (event) {
                event.preventDefault();
                 $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                }
            });
                $.post($(this).attr('action'),
                        $(this).serialize()
                ).done(function (data) {
                            if (data.errors == null) {
                                $('input').val("");
                                $('textarea').val("");
                                $('#create-button').toggle();


                                $('.chatroom').append('<a href="/chatroom/' + data.chatroom_id + '" class="btn btn-warning">' + data.chatroom_name + '</a>');
                            }
                        }).fail(function (data) {
                            $('#error_bank').append('<p>' + data.errors + '</p>');

                        });
            });

            $('.delete_chatroom').click(function (event) {
                 $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
                }
            });
                $.post("{% url 'viewer:delete_chatroom' %}", {'chatroom_id': $(this).attr('data-chatroom_id')}).done(function (data) {
                    if (data.success) {
                        $(this).parent().remove();
                    }
                })
            })
        });
    </script>

{% endblock %}
